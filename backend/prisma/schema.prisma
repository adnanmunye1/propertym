// Prisma Schema for Property Management Application
// Database: PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum UserRole {
  OWNER
  STAFF
}

enum PropertyType {
  APARTMENT_BLOCK
  SINGLE_HOUSE
  BEDSITTER_BLOCK
  COMMERCIAL
  OTHER
}

enum UnitStatus {
  VACANT
  OCCUPIED
  RESERVED
  INACTIVE
}

enum TenantStatus {
  ACTIVE
  NOTICE_GIVEN
  FORMER
}

enum DepositStatus {
  HELD
  REFUNDED
  FORFEITED
}

enum InvoiceStatus {
  PENDING
  PARTIALLY_PAID
  PAID
  OVERDUE
}

enum PaymentMethod {
  MPESA
  BANK_TRANSFER
  CASH
  AIRTEL_MONEY
  OTHER
}

enum DocumentType {
  AGREEMENT
  NOTICE
  ID
  RECEIPT
  OTHER
}

enum EntityType {
  PROPERTY
  UNIT
  TENANT
  SYSTEM
}

// ============================================
// MODELS
// ============================================

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  firstName String   @map("first_name")
  lastName  String   @map("last_name")
  role      UserRole @default(OWNER)
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  documents Document[]

  @@index([email])
  @@index([isActive])
  @@map("users")
}

model Property {
  id          String       @id @default(uuid())
  name        String
  type        PropertyType
  area        String?
  town        String?
  county      String?
  address     String?
  description String?
  isActive    Boolean      @default(true) @map("is_active")
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")

  // Relations
  units    Unit[]
  images   PropertyImage[]
  documents Document[]

  @@index([isActive])
  @@index([name])
  @@map("properties")
}

model PropertyImage {
  id         String   @id @default(uuid())
  propertyId String   @map("property_id")
  fileName   String   @map("file_name")
  storageKey String   @map("storage_key")
  storageUrl String   @map("storage_url")
  isPrimary  Boolean  @default(false) @map("is_primary")
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@index([propertyId])
  @@map("property_images")
}

model Unit {
  id            String     @id @default(uuid())
  propertyId    String     @map("property_id")
  name          String
  bedrooms      Int?
  bathrooms     Int?
  floor         String?
  size          Decimal?   @db.Decimal(10, 2)
  rentAmount    Decimal    @map("rent_amount") @db.Decimal(10, 2)
  depositAmount Decimal    @map("deposit_amount") @db.Decimal(10, 2)
  status        UnitStatus @default(VACANT)
  notes         String?
  createdAt     DateTime   @default(now()) @map("created_at")
  updatedAt     DateTime   @updatedAt @map("updated_at")

  // Relations
  property  Property    @relation(fields: [propertyId], references: [id], onDelete: Restrict)
  tenancies Tenancy[]
  invoices  Invoice[]
  payments  Payment[]
  images    UnitImage[]
  documents Document[]

  @@unique([propertyId, name])
  @@index([propertyId])
  @@index([status])
  @@map("units")
}

model UnitImage {
  id         String   @id @default(uuid())
  unitId     String   @map("unit_id")
  fileName   String   @map("file_name")
  storageKey String   @map("storage_key")
  storageUrl String   @map("storage_url")
  isPrimary  Boolean  @default(false) @map("is_primary")
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  unit Unit @relation(fields: [unitId], references: [id], onDelete: Cascade)

  @@index([unitId])
  @@map("unit_images")
}

model Tenant {
  id                     String       @id @default(uuid())
  firstName              String       @map("first_name")
  lastName               String       @map("last_name")
  idNumber               String       @map("id_number")
  phone                  String
  email                  String?
  emergencyContactName   String?      @map("emergency_contact_name")
  emergencyContactPhone  String?      @map("emergency_contact_phone")
  status                 TenantStatus @default(ACTIVE)
  notes                  String?
  createdAt              DateTime     @default(now()) @map("created_at")
  updatedAt              DateTime     @updatedAt @map("updated_at")

  // Relations
  tenancies Tenancy[]
  invoices  Invoice[]
  payments  Payment[]
  documents Document[]

  @@index([phone])
  @@index([status])
  @@index([idNumber])
  @@index([firstName, lastName])
  @@map("tenants")
}

model Tenancy {
  id                 String        @id @default(uuid())
  tenantId           String        @map("tenant_id")
  unitId             String        @map("unit_id")
  moveInDate         DateTime      @map("move_in_date") @db.Date
  moveOutDate        DateTime?     @map("move_out_date") @db.Date
  depositPaid        Decimal       @default(0) @map("deposit_paid") @db.Decimal(10, 2)
  depositPaidDate    DateTime?     @map("deposit_paid_date") @db.Date
  depositRefunded    Decimal       @default(0) @map("deposit_refunded") @db.Decimal(10, 2)
  depositRefundDate  DateTime?     @map("deposit_refund_date") @db.Date
  depositStatus      DepositStatus @default(HELD) @map("deposit_status")
  isActive           Boolean       @default(true) @map("is_active")
  notes              String?
  createdAt          DateTime      @default(now()) @map("created_at")
  updatedAt          DateTime      @updatedAt @map("updated_at")

  // Relations
  tenant   Tenant    @relation(fields: [tenantId], references: [id], onDelete: Restrict)
  unit     Unit      @relation(fields: [unitId], references: [id], onDelete: Restrict)
  invoices Invoice[]

  @@index([tenantId])
  @@index([unitId])
  @@index([isActive])
  @@index([moveInDate])
  @@map("tenancies")
}

model Invoice {
  id                String        @id @default(uuid())
  tenancyId         String        @map("tenancy_id")
  tenantId          String        @map("tenant_id")
  unitId            String        @map("unit_id")
  period            String // Format: YYYY-MM
  dueDate           DateTime      @map("due_date") @db.Date
  rentAmount        Decimal       @map("rent_amount") @db.Decimal(10, 2)
  additionalCharges Decimal       @default(0) @map("additional_charges") @db.Decimal(10, 2)
  totalAmount       Decimal       @map("total_amount") @db.Decimal(10, 2)
  paidAmount        Decimal       @default(0) @map("paid_amount") @db.Decimal(10, 2)
  status            InvoiceStatus @default(PENDING)
  notes             String?
  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")

  // Relations
  tenancy  Tenancy   @relation(fields: [tenancyId], references: [id], onDelete: Restrict)
  tenant   Tenant    @relation(fields: [tenantId], references: [id], onDelete: Restrict)
  unit     Unit      @relation(fields: [unitId], references: [id], onDelete: Restrict)
  payments Payment[]

  @@unique([tenancyId, period])
  @@index([tenancyId])
  @@index([tenantId])
  @@index([unitId])
  @@index([period])
  @@index([dueDate])
  @@index([status])
  @@map("invoices")
}

model Payment {
  id          String        @id @default(uuid())
  tenantId    String        @map("tenant_id")
  unitId      String        @map("unit_id")
  invoiceId   String?       @map("invoice_id")
  paymentDate DateTime      @map("payment_date") @db.Date
  amount      Decimal       @db.Decimal(10, 2)
  method      PaymentMethod
  reference   String?
  notes       String?
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")

  // Relations
  tenant  Tenant   @relation(fields: [tenantId], references: [id], onDelete: Restrict)
  unit    Unit     @relation(fields: [unitId], references: [id], onDelete: Restrict)
  invoice Invoice? @relation(fields: [invoiceId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([unitId])
  @@index([invoiceId])
  @@index([paymentDate])
  @@index([method])
  @@map("payments")
}

model Document {
  id           String       @id @default(uuid())
  fileName     String       @map("file_name")
  fileSize     Int          @map("file_size")
  mimeType     String       @map("mime_type")
  storageKey   String       @map("storage_key")
  storageUrl   String       @map("storage_url")
  documentType DocumentType @map("document_type")
  entityType   EntityType   @map("entity_type")
  propertyId   String?      @map("property_id")
  unitId       String?      @map("unit_id")
  tenantId     String?      @map("tenant_id")
  uploadedBy   String       @map("uploaded_by")
  notes        String?
  createdAt    DateTime     @default(now()) @map("created_at")
  updatedAt    DateTime     @updatedAt @map("updated_at")

  // Relations
  property   Property? @relation(fields: [propertyId], references: [id], onDelete: SetNull)
  unit       Unit?     @relation(fields: [unitId], references: [id], onDelete: SetNull)
  tenant     Tenant?   @relation(fields: [tenantId], references: [id], onDelete: SetNull)
  uploader   User      @relation(fields: [uploadedBy], references: [id], onDelete: Restrict)

  @@index([entityType])
  @@index([propertyId])
  @@index([unitId])
  @@index([tenantId])
  @@index([uploadedBy])
  @@index([documentType])
  @@map("documents")
}
